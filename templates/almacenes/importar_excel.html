{% extends 'layout.html' %}
{% load static %}

{% block title %}Importar Excel - Sistema{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'almacenes/ImportarExcel.css' %}">

<div class="importar-container">
  
  <!-- Header -->
  <div class="importar-header">
    <h1>
      <i class="fa-solid fa-file-excel"></i>
      Importar Productos desde Excel
    </h1>
    <p style="color: #666; font-size: 14px; margin-top: 8px;">
      Importa productos para <strong style="color: #148129;">todos los almacenes</strong> en una sola operaci√≥n
    </p>
  </div>

  <!-- Instrucciones -->
  <div class="card-instrucciones">
    <h3>
      <i class="fa-solid fa-circle-info"></i>
      Instrucciones
    </h3>
    <ul>
      <li><strong>Columnas OBLIGATORIAS:</strong> codigo_almacen, codigo_producto, nombre, cantidad, unidad, estado</li>
      <li><strong>C√≥digos de almac√©n v√°lidos:</strong> 01 (Almac√©n General), 02 (Almac√©n Deporte), 03 (Almac√©n √ötiles)</li>
      <li><strong>C√≥digos de producto:</strong> Identificador √∫nico del producto (ej: PRD-001, PRD-002, etc.)</li>
      <li><strong>Estados v√°lidos:</strong> DISP (Disponible), AGOT (Agotado), BAJO (Stock Bajo)</li>
      <li><strong>Unidades:</strong> Unidad, Paquete, Caja, Kg, etc. (se crear√°n autom√°ticamente si no existen)</li>
      <li><strong>Importante:</strong> Los productos se crear√°n en el almac√©n correspondiente seg√∫n el c√≥digo_almacen</li>
    </ul>
  </div>

  <!-- Formulario -->
  <div class="card-formulario">
    <form method="POST" enctype="multipart/form-data" id="formImportar">
      {% csrf_token %}
      
      <!-- üî• Campo oculto para redirigir correctamente -->
      <input type="hidden" name="redirect_to" value="{{ redirect_to }}">
      
      <div class="file-upload-area">
        <label>
          <i class="fa-solid fa-upload"></i>
          Selecciona el archivo Excel
        </label>
        <div class="file-input-wrapper">
          <input 
            type="file" 
            name="archivo_excel" 
            id="archivoExcel"
            accept=".xlsx,.xls" 
            required
          >
          <i class="fa-solid fa-cloud-arrow-up file-upload-icon"></i>
          <span class="file-upload-text">Arrastra tu archivo o haz clic para seleccionar</span>
          <span class="file-upload-hint">Formatos: .xlsx, .xls</span>
        </div>
        <div class="file-name-display" id="fileNameDisplay">
          <i class="fa-solid fa-file-excel"></i>
          <span id="fileName"></span>
        </div>
      </div>

      <div class="botones-container">
        <button type="button" class="btn-primary" id="btnPrevisualizar" disabled>
          <i class="fa-solid fa-eye"></i>
          Previsualizar Datos
        </button>
        
        <button type="submit" class="btn-primary" id="btnImportar" style="display: none;">
          <i class="fa-solid fa-check"></i>
          Confirmar Importaci√≥n
        </button>
        
        <a href="{% url redirect_to %}" class="btn-secondary">
          <i class="fa-solid fa-arrow-left"></i>
          Cancelar
        </a>
      </div>
    </form>
  </div>

  <!-- Vista Previa -->
  <div class="preview-container" id="previewContainer">
    <div class="preview-header">
      <h3>
        <i class="fa-solid fa-table"></i>
        Vista Previa de Datos
      </h3>
    </div>
    
    <!-- Resumen por almac√©n -->
    <div class="preview-summary" id="previewSummary" style="display: none;">
      <div class="summary-cards">
        <div class="summary-card" id="summaryAG">
          <i class="fa-solid fa-boxes-stacked"></i>
          <div>
            <span class="summary-label">Almac√©n General</span>
            <span class="summary-value" id="countAG">0</span>
          </div>
        </div>
        <div class="summary-card" id="summaryAD">
          <i class="fa-solid fa-basketball"></i>
          <div>
            <span class="summary-label">Almac√©n Deporte</span>
            <span class="summary-value" id="countAD">0</span>
          </div>
        </div>
        <div class="summary-card" id="summaryIU">
          <i class="fa-solid fa-book"></i>
          <div>
            <span class="summary-label">Almac√©n √ötiles</span>
            <span class="summary-value" id="countIU">0</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="preview-info">
      <i class="fa-solid fa-circle-check"></i>
      Se encontraron <strong><span id="totalRegistros">0</span> registros</strong> para importar
    </div>
    
    <div class="tabla-preview-container">
      <table class="tabla-preview">
        <thead>
          <tr>
            <th>C√≥digo Almac√©n</th>
            <th>C√≥digo Producto</th>
            <th>Nombre</th>
            <th>Descripci√≥n</th>
            <th>Cantidad</th>
            <th>Unidad</th>
            <th>Estado</th>
            <th>Estante</th>
          </tr>
        </thead>
        <tbody id="previewTableBody">
          <!-- Datos din√°micos -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Consejo -->
  <div class="card-consejo">
    <i class="fa-solid fa-lightbulb" style="color: #856404; font-size: 20px;"></i>
    <div>
      <strong>üí° Consejo:</strong> Descarga la <a href="{% url 'descargar_plantilla' %}">plantilla de ejemplo</a> para asegurarte de que tu archivo tenga el formato correcto.
    </div>
  </div>

</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="spinner"></div>
    <p style="color: #148129; font-weight: 600; font-size: 16px;">Procesando archivo...</p>
  </div>
</div>

<style>
/* Estilos adicionales para el resumen */
.preview-summary {
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-bottom: 20px;
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.summary-card {
  background: white;
  padding: 16px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  border-left: 4px solid #148129;
}

.summary-card i {
  font-size: 28px;
  color: #148129;
}

.summary-card div {
  display: flex;
  flex-direction: column;
}

.summary-label {
  font-size: 12px;
  color: #666;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.summary-value {
  font-size: 24px;
  font-weight: 700;
  color: #148129;
}

/* Badges de ubicaci√≥n */
.badge-preview {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 600;
  white-space: nowrap;
}

.badge-01 {
  background: #d1f4e0;
  color: #0d6832;
}

.badge-02 {
  background: #e3f2fd;
  color: #0d47a1;
}

.badge-03 {
  background: #fff3e0;
  color: #e65100;
}

.badge-disp {
  background: #d1fae5;
  color: #065f46;
}

.badge-bajo {
  background: #fef3c7;
  color: #92400e;
}

.badge-agot {
  background: #fee2e2;
  color: #991b1b;
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const archivoInput = document.getElementById('archivoExcel');
const fileNameDisplay = document.getElementById('fileNameDisplay');
const fileName = document.getElementById('fileName');
const btnPrevisualizar = document.getElementById('btnPrevisualizar');
const btnImportar = document.getElementById('btnImportar');
const previewContainer = document.getElementById('previewContainer');
const previewTableBody = document.getElementById('previewTableBody');
const totalRegistros = document.getElementById('totalRegistros');
const loadingOverlay = document.getElementById('loadingOverlay');
const previewSummary = document.getElementById('previewSummary');

let datosExcel = [];

// Mostrar nombre del archivo
archivoInput.addEventListener('change', function(e) {
  if (e.target.files.length > 0) {
    const file = e.target.files[0];
    fileName.textContent = file.name;
    fileNameDisplay.classList.add('show');
    btnPrevisualizar.disabled = false;
  } else {
    fileNameDisplay.classList.remove('show');
    btnPrevisualizar.disabled = true;
  }
});

// Previsualizar datos
btnPrevisualizar.addEventListener('click', function() {
  const file = archivoInput.files[0];
  if (!file) {
    alert('Por favor selecciona un archivo');
    return;
  }

  loadingOverlay.classList.add('show');
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet);
      
      // Validar columnas obligatorias
      if (jsonData.length > 0) {
        const primeraFila = jsonData[0];
        const columnasRequeridas = ['codigo_almacen', 'codigo_producto', 'nombre', 'cantidad', 'unidad', 'estado'];
        const columnasFaltantes = columnasRequeridas.filter(col => !(col in primeraFila));
        
        if (columnasFaltantes.length > 0) {
          loadingOverlay.classList.remove('show');
          alert('‚ùå Faltan columnas obligatorias: ' + columnasFaltantes.join(', '));
          return;
        }
      }
      
      datosExcel = jsonData;
      mostrarPreview(jsonData);
      
      loadingOverlay.classList.remove('show');
      previewContainer.classList.add('show');
      btnPrevisualizar.style.display = 'none';
      btnImportar.style.display = 'flex';
      
      // Scroll a la preview
      previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
    } catch (error) {
      loadingOverlay.classList.remove('show');
      alert('Error al leer el archivo: ' + error.message);
    }
  };
  
  reader.readAsArrayBuffer(file);
});

function mostrarPreview(datos) {
  totalRegistros.textContent = datos.length;
  previewTableBody.innerHTML = '';
  
  const ubicacionesLabels = {
    '01': 'Almac√©n General',
    '02': 'Almac√©n Deporte',
    '03': 'Almac√©n √ötiles'
  };
  
  const estadosLabels = {
    'DISP': 'Disponible',
    'BAJO': 'Stock Bajo',
    'AGOT': 'Agotado'
  };
  
  // Contar productos por almac√©n
  let countAG = 0, countAD = 0, countIU = 0;
  
  datos.forEach((row) => {
    const codigoAlmacen = String(row.codigo_almacen || '').padStart(2, '0');
    const codigoProducto = row.codigo_producto || '';
    const estado = (row.estado || 'DISP').toUpperCase();
    const descripcion = row.descripcion || '-';
    const estante = row.estante || '-';
    
    // Contar por almac√©n
    if (codigoAlmacen === '01') countAG++;
    else if (codigoAlmacen === '02') countAD++;
    else if (codigoAlmacen === '03') countIU++;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="badge-preview badge-${codigoAlmacen}">${ubicacionesLabels[codigoAlmacen] || 'Desconocido'}</span></td>
      <td><strong style="font-family: monospace; color: #148129;">${codigoProducto}</strong></td>
      <td><strong>${row.nombre || ''}</strong></td>
      <td style="color: #666; font-size: 13px;">${descripcion}</td>
      <td style="text-align: center;"><strong>${row.cantidad || 0}</strong></td>
      <td>${row.unidad || ''}</td>
      <td><span class="badge-preview badge-${estado.toLowerCase()}">${estadosLabels[estado] || estado}</span></td>
      <td style="color: #666;">${estante}</td>
    `;
    previewTableBody.appendChild(tr);
  });
  
  // Mostrar resumen
  document.getElementById('countAG').textContent = countAG;
  document.getElementById('countAD').textContent = countAD;
  document.getElementById('countIU').textContent = countIU;
  
  if (countAG > 0 || countAD > 0 || countIU > 0) {
    previewSummary.style.display = 'block';
  }
}

// Loading al enviar
document.getElementById('formImportar').addEventListener('submit', function() {
  loadingOverlay.classList.add('show');
});
</script>

{% endblock %}