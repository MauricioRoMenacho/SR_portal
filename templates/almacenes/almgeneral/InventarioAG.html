{% extends 'layout.html' %}
{% load static %}

{% block title %}Inventario Almacén General - Sistema{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'almacenes/almgeneral/InventarioAG.css' %}">

<div class="inventario-container">
  
  <!-- Header -->
  <div class="inventario-header">
    <h1>
      <i class="fa-solid fa-boxes-stacked"></i>
      Inventario - Almacén General
    </h1>

    <a href="{% url 'agregar_producto' %}">
      <button class="btn-primary">
        <i class="fa-solid fa-plus"></i>
        Agregar Producto
      </button>
    </a>
    <a href="{% url 'importar_excel' %}">
      <button class="btn-secondary">
        <i class="fa-solid fa-file-excel"></i>
        Importar Excel
      </button>
    </a>
  </div>

  <!-- Filtros -->
  <div class="filtros-container">
    
    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-search"></i>
        Nombre del Producto
      </label>
      <input 
        type="text" 
        id="filtroNombre" 
        class="filtro-input" 
        placeholder="Escribe para buscar..."
      >
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-layer-group"></i>
        Estado
      </label>
      <select id="filtroEstado" class="filtro-input">
        <option value="">Todos los estados</option>
        <option value="DISP">Disponible</option>
        <option value="BAJO">Stock Bajo</option>
        <option value="AGOT">Agotado</option>
      </select>
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-location-dot"></i>
        Estante
      </label>
      <input 
        type="text" 
        id="filtroEstante" 
        class="filtro-input" 
        placeholder="Ej: A1, B2..."
      >
    </div>

    <button class="btn-limpiar" onclick="limpiarFiltros()">
      <i class="fa-solid fa-eraser"></i>
      Limpiar Filtros
    </button>

  </div>

  <!-- Contador de resultados -->
  <div class="resultados-info">
    Mostrando <strong id="contadorResultados">{{ total_productos }}</strong> de <strong id="totalProductos">{{ total_productos }}</strong> productos
  </div>

  <!-- Tabla de inventario -->
  <div class="tabla-container">
    <table class="tabla-inventario">
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>Descripción</th>
          <th>Cantidad</th>
          <th>Unidad</th>
          <th>Ubicación</th>
          <th>Estado</th>
          <th>Fecha Ingreso</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaBody">
        
        {% for producto in productos %}
        <tr data-nombre="{{ producto.nombre|lower }}" 
            data-estado="{{ producto.estado }}" 
            data-estante="{{ producto.estante|lower }}">
          
          <td class="codigo">PRD-{{ producto.id_producto|stringformat:"03d" }}</td>
          <td class="nombre">{{ producto.nombre }}</td>
          <td>{{ producto.descripcion }}</td>
          <td class="cantidad">{{ producto.cantidad }}</td>
          <td>{{ producto.unidad }}</td>
          <td>{{ producto.estante }}</td>
          <td>
            {% if producto.estado == 'DISP' %}
              <span class="badge estado-disponible">Disponible</span>
            {% elif producto.estado == 'BAJO' %}
              <span class="badge estado-bajo">Stock Bajo</span>
            {% elif producto.estado == 'AGOT' %}
              <span class="badge estado-agotado">Agotado</span>
            {% endif %}
          </td>
          <td>{{ producto.fecha_ingreso|date:"d/m/Y" }}</td>
          <td class="acciones">
            <button class="btn-icon btn-danger btn-eliminar" 
                    title="Eliminar" 
                    type="button"
                    data-id="{{ producto.id_producto }}" 
                    data-nombre="{{ producto.nombre }}">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="9" style="text-align: center; padding: 2rem;">
            No hay productos registrados en el Almacén General
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>

  <!-- Mensaje si no hay resultados -->
  <div id="sinResultados" class="sin-resultados" style="display: none;">
    <i class="fa-solid fa-box-open"></i>
    <p>No se encontraron productos con los filtros seleccionados</p>
  </div>

</div>

<script>
// Filtrado en tiempo real
const filtroNombre = document.getElementById('filtroNombre');
const filtroEstado = document.getElementById('filtroEstado');
const filtroEstante = document.getElementById('filtroEstante');
const tablaBody = document.getElementById('tablaBody');
const contadorResultados = document.getElementById('contadorResultados');
const totalProductos = document.getElementById('totalProductos');
const sinResultados = document.getElementById('sinResultados');

// Total de productos
const totalFilas = tablaBody.querySelectorAll('tr[data-nombre]').length;
totalProductos.textContent = totalFilas;

function filtrarTabla() {
  const nombre = filtroNombre.value.toLowerCase();
  const estado = filtroEstado.value;
  const estante = filtroEstante.value.toLowerCase();
  
  const filas = tablaBody.querySelectorAll('tr[data-nombre]');
  let contador = 0;
  
  filas.forEach(fila => {
    const dataNombre = fila.getAttribute('data-nombre');
    const dataEstado = fila.getAttribute('data-estado');
    const dataEstante = fila.getAttribute('data-estante');
    
    const cumpleNombre = nombre === '' || dataNombre.includes(nombre);
    const cumpleEstado = estado === '' || dataEstado === estado;
    const cumpleEstante = estante === '' || dataEstante.includes(estante);
    
    if (cumpleNombre && cumpleEstado && cumpleEstante) {
      fila.style.display = '';
      contador++;
    } else {
      fila.style.display = 'none';
    }
  });
  
  contadorResultados.textContent = contador;
  
  // Mostrar mensaje si no hay resultados
  if (contador === 0 && totalFilas > 0) {
    sinResultados.style.display = 'flex';
    document.querySelector('.tabla-container').style.display = 'none';
  } else {
    sinResultados.style.display = 'none';
    document.querySelector('.tabla-container').style.display = 'block';
  }
}

// Eventos de filtrado en tiempo real
filtroNombre.addEventListener('input', filtrarTabla);
filtroEstado.addEventListener('change', filtrarTabla);
filtroEstante.addEventListener('input', filtrarTabla);

function limpiarFiltros() {
  filtroNombre.value = '';
  filtroEstado.value = '';
  filtroEstante.value = '';
  filtrarTabla();
}

// Manejo de eliminación con event delegation
document.addEventListener('click', function(e) {
  if (e.target.closest('.btn-eliminar')) {
    const btn = e.target.closest('.btn-eliminar');
    const id = btn.getAttribute('data-id');
    const nombre = btn.getAttribute('data-nombre');
    
    if (confirm('¿Estás seguro de eliminar el producto "' + nombre + '"?')) {
      window.location.href = '/eliminar-producto/' + id + '/';
    }
  }
});
</script>

{% endblock %}