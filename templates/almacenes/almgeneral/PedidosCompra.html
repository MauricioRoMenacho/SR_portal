{% extends 'layout.html' %}
{% load static %}

{% block title %}Pedidos de Compra - Sistema{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'almacenes/almgeneral/PedidosCompra.css' %}">

<div class="pedidos-container">
  
  <!-- Mensajes de feedback -->
  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      <i class="fa-solid {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %}"></i>
      {{ message }}
      <button class="btn-close-alert" onclick="this.parentElement.remove()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Header -->
  <div class="pedidos-header">
    <h1>
      <i class="fa-solid fa-clipboard-list"></i>
      Pedidos de Compra
    </h1>
    <button class="btn-primary" onclick="abrirModalNuevoPedido()">
      <i class="fa-solid fa-plus"></i>
      Nuevo Pedido de Compra
    </button>
  </div>

  <!-- Filtros -->
  <div class="filtros-container">
    
    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-search"></i>
        Buscar
      </label>
      <input 
        type="text" 
        id="filtroBuscar" 
        class="filtro-input" 
        placeholder="Nombre, código o descripción..."
      >
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-filter"></i>
        Estado
      </label>
      <select id="filtroEstado" class="filtro-input">
        <option value="">Todos los estados</option>
        <option value="PEND">Pendiente</option>
        <option value="COMP">Completado</option>
        <option value="ENTR">Entregado</option>
      </select>
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-calendar"></i>
        Fecha Desde
      </label>
      <input 
        type="date" 
        id="filtroFechaDesde" 
        class="filtro-input"
      >
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-calendar"></i>
        Fecha Hasta
      </label>
      <input 
        type="date" 
        id="filtroFechaHasta" 
        class="filtro-input"
      >
    </div>

    <button class="btn-limpiar" onclick="limpiarFiltros()">
      <i class="fa-solid fa-eraser"></i>
      Limpiar
    </button>

  </div>

  <!-- Contador de resultados -->
  <div class="resultados-info">
    Mostrando <strong id="contadorResultados">{{ total_pedidos }}</strong> de <strong id="totalPedidos">{{ total_pedidos }}</strong> pedidos
  </div>

  <!-- Tabla de pedidos -->
  <div class="tabla-container">
    <table class="tabla-pedidos">
      <thead>
        <tr>
          <th>Código</th>
          <th>Nombre</th>
          <th>Descripción</th>
          <th>Archivo</th>
          <th>Estado</th>
          <th>Fecha Creación</th>
          <th>Última Modificación</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tablaBody">
        
        {% for pedido in pedidos %}
        <tr data-nombre="{{ pedido.nombre|lower }}" 
            data-codigo="{{ pedido.codigo|lower }}"
            data-estado="{{ pedido.estado }}"
            data-fecha="{{ pedido.fecha_creacion|date:'Y-m-d' }}">
          
          <td class="codigo">
            <strong>PC-{{ pedido.id_pedido|stringformat:"04d" }}</strong>
          </td>
          <td class="nombre">{{ pedido.nombre }}</td>
          <td class="descripcion">{{ pedido.descripcion|truncatewords:8 }}</td>
          <td class="archivo-cell">
            {% if pedido.archivo %}
            <a href="{{ pedido.archivo.url }}" target="_blank" class="archivo-link" title="Descargar archivo">
              <i class="fa-solid fa-file-{% if pedido.archivo.name|slice:'-3:' == 'pdf' %}pdf{% else %}word{% endif %}"></i>
              {{ pedido.archivo.name|slice:"-20:" }}
            </a>
            {% else %}
            <span class="sin-archivo">Sin archivo</span>
            {% endif %}
          </td>
          <td>
            {% if pedido.estado == 'PEND' %}
              <span class="badge estado-pendiente">
                <i class="fa-solid fa-clock"></i>
                Pendiente
              </span>
            {% elif pedido.estado == 'COMP' %}
              <span class="badge estado-completado">
                <i class="fa-solid fa-check"></i>
                Completado
              </span>
            {% elif pedido.estado == 'ENTR' %}
              <span class="badge estado-entregado">
                <i class="fa-solid fa-box-open"></i>
                Entregado
              </span>
            {% endif %}
          </td>
          <td>{{ pedido.fecha_creacion|date:"d/m/Y H:i" }}</td>
          <td>{{ pedido.fecha_modificacion|date:"d/m/Y H:i" }}</td>
          <td class="acciones">
            <button class="btn-icon btn-info" 
                    title="Ver Detalles" 
                    data-id="{{ pedido.id_pedido }}"
                    onclick="verDetallesPedido(this.dataset.id)">
              <i class="fa-solid fa-eye"></i>
            </button>
            <button class="btn-icon btn-success" 
                    title="Ver Cotizaciones" 
                    data-id="{{ pedido.id_pedido }}"
                    onclick="verCotizaciones(this.dataset.id)">
              <i class="fa-solid fa-file-invoice-dollar"></i>
            </button>
            <button class="btn-icon btn-warning" 
                    title="Editar" 
                    data-id="{{ pedido.id_pedido }}"
                    onclick="editarPedido(this.dataset.id)">
              <i class="fa-solid fa-edit"></i>
            </button>
            <button class="btn-icon btn-danger" 
                    title="Eliminar" 
                    data-id="{{ pedido.id_pedido }}"
                    data-nombre="{{ pedido.nombre }}"
                    onclick="eliminarPedido(this.dataset.id, this.dataset.nombre)">
              <i class="fa-solid fa-trash"></i>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" style="text-align: center; padding: 3rem; color: #666;">
            <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 1rem; display: block; color: #ccc;"></i>
            No hay pedidos de compra registrados
          </td>
        </tr>
        {% endfor %}

      </tbody>
    </table>
  </div>

  <!-- Mensaje si no hay resultados -->
  <div id="sinResultados" class="sin-resultados" style="display: none;">
    <i class="fa-solid fa-search"></i>
    <p>No se encontraron pedidos con los filtros seleccionados</p>
    <button class="btn-secondary" onclick="limpiarFiltros()">
      <i class="fa-solid fa-rotate-left"></i>
      Limpiar Filtros
    </button>
  </div>

</div>

<!-- Modal: Nuevo Pedido de Compra -->
<div class="modal-overlay" id="modalNuevoPedido">
  <div class="modal-content">
    <div class="modal-header">
      <h2>
        <i class="fa-solid fa-plus-circle"></i>
        Nuevo Pedido de Compra
      </h2>
      <button class="btn-close" onclick="cerrarModalNuevoPedido()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
    
    <form method="POST" action="{% url 'PedidosCompra' %}" enctype="multipart/form-data" id="formNuevoPedido">
      {% csrf_token %}
      
      <div class="modal-body">
        
        <div class="form-group">
          <label>
            <i class="fa-solid fa-tag"></i>
            Nombre del Pedido *
          </label>
          <input 
            type="text" 
            name="nombre" 
            id="nombrePedido"
            class="form-input" 
            placeholder="Ej: Equipamiento Deportivo 2025"
            required
          >
        </div>

        <div class="form-group">
          <label>
            <i class="fa-solid fa-align-left"></i>
            Descripción
          </label>
          <textarea 
            name="descripcion" 
            class="form-input" 
            rows="4"
            placeholder="Describe brevemente el pedido de compra..."
          ></textarea>
        </div>

        <div class="form-group">
          <label>
            <i class="fa-solid fa-file-upload"></i>
            Archivo del Pedido (PDF o Word) *
          </label>
          <div class="file-upload-wrapper">
            <input 
              type="file" 
              name="archivo" 
              id="archivoInput"
              class="file-input" 
              accept=".pdf,.doc,.docx"
              required
            >
            <label for="archivoInput" class="file-label">
              <i class="fa-solid fa-cloud-upload-alt"></i>
              <span id="fileNameDisplay">Seleccionar archivo PDF o Word</span>
            </label>
          </div>
          <small class="file-hint">
            <i class="fa-solid fa-info-circle"></i>
            Formatos permitidos: PDF, DOC, DOCX (Máx. 10MB)
          </small>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="cerrarModalNuevoPedido()">
          <i class="fa-solid fa-times"></i>
          Cancelar
        </button>
        <button type="submit" class="btn-primary" id="btnSubmit">
          <i class="fa-solid fa-save"></i>
          Crear Pedido
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// ========== FILTROS ==========
const filtroBuscar = document.getElementById('filtroBuscar');
const filtroEstado = document.getElementById('filtroEstado');
const filtroFechaDesde = document.getElementById('filtroFechaDesde');
const filtroFechaHasta = document.getElementById('filtroFechaHasta');
const tablaBody = document.getElementById('tablaBody');
const contadorResultados = document.getElementById('contadorResultados');
const totalPedidos = document.getElementById('totalPedidos');
const sinResultados = document.getElementById('sinResultados');

const totalFilas = tablaBody.querySelectorAll('tr[data-nombre]').length;
totalPedidos.textContent = totalFilas;

function filtrarTabla() {
  const buscar = filtroBuscar.value.toLowerCase();
  const estado = filtroEstado.value;
  const fechaDesde = filtroFechaDesde.value;
  const fechaHasta = filtroFechaHasta.value;
  
  const filas = tablaBody.querySelectorAll('tr[data-nombre]');
  let contador = 0;
  
  filas.forEach(fila => {
    const nombre = fila.getAttribute('data-nombre');
    const codigo = fila.getAttribute('data-codigo');
    const estadoFila = fila.getAttribute('data-estado');
    const fechaFila = fila.getAttribute('data-fecha');
    
    const cumpleBuscar = buscar === '' || nombre.includes(buscar) || codigo.includes(buscar);
    const cumpleEstado = estado === '' || estadoFila === estado;
    const cumpleFechaDesde = fechaDesde === '' || fechaFila >= fechaDesde;
    const cumpleFechaHasta = fechaHasta === '' || fechaFila <= fechaHasta;
    
    if (cumpleBuscar && cumpleEstado && cumpleFechaDesde && cumpleFechaHasta) {
      fila.style.display = '';
      contador++;
    } else {
      fila.style.display = 'none';
    }
  });
  
  contadorResultados.textContent = contador;
  
  if (contador === 0 && totalFilas > 0) {
    sinResultados.style.display = 'flex';
    document.querySelector('.tabla-container').style.display = 'none';
  } else {
    sinResultados.style.display = 'none';
    document.querySelector('.tabla-container').style.display = 'block';
  }
}

filtroBuscar.addEventListener('input', filtrarTabla);
filtroEstado.addEventListener('change', filtrarTabla);
filtroFechaDesde.addEventListener('change', filtrarTabla);
filtroFechaHasta.addEventListener('change', filtrarTabla);

function limpiarFiltros() {
  filtroBuscar.value = '';
  filtroEstado.value = '';
  filtroFechaDesde.value = '';
  filtroFechaHasta.value = '';
  filtrarTabla();
}

// ========== MODAL ==========
function abrirModalNuevoPedido() {
  document.getElementById('modalNuevoPedido').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function cerrarModalNuevoPedido() {
  document.getElementById('modalNuevoPedido').classList.remove('show');
  document.body.style.overflow = 'auto';
  document.getElementById('formNuevoPedido').reset();
  document.getElementById('fileNameDisplay').textContent = 'Seleccionar archivo PDF o Word';
}

// Cerrar modal al hacer clic fuera
document.getElementById('modalNuevoPedido').addEventListener('click', function(e) {
  if (e.target === this) {
    cerrarModalNuevoPedido();
  }
});

// ========== MANEJO DE ARCHIVO ==========
const archivoInput = document.getElementById('archivoInput');
const fileNameDisplay = document.getElementById('fileNameDisplay');

archivoInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  
  if (file) {
    // Validar tamaño (10MB = 10 * 1024 * 1024 bytes)
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
      alert('El archivo es demasiado grande. Máximo 10MB permitido.');
      archivoInput.value = '';
      fileNameDisplay.textContent = 'Seleccionar archivo PDF o Word';
      return;
    }
    
    // Validar extensión
    const extension = file.name.split('.').pop().toLowerCase();
    const tiposPermitidos = ['pdf', 'doc', 'docx'];
    
    if (!tiposPermitidos.includes(extension)) {
      alert('Formato no permitido. Solo se aceptan archivos PDF, DOC o DOCX.');
      archivoInput.value = '';
      fileNameDisplay.textContent = 'Seleccionar archivo PDF o Word';
      return;
    }
    
    // Mostrar nombre del archivo
    fileNameDisplay.innerHTML = `<i class="fa-solid fa-file-${extension === 'pdf' ? 'pdf' : 'word'}"></i> ${file.name}`;
  } else {
    fileNameDisplay.textContent = 'Seleccionar archivo PDF o Word';
  }
});

// Validación del formulario antes de enviar
document.getElementById('formNuevoPedido').addEventListener('submit', function(e) {
  const nombre = document.getElementById('nombrePedido').value.trim();
  const archivo = document.getElementById('archivoInput').files[0];
  
  if (!nombre) {
    e.preventDefault();
    alert('El nombre del pedido es obligatorio');
    return false;
  }
  
  if (!archivo) {
    e.preventDefault();
    alert('Debes seleccionar un archivo PDF o Word');
    return false;
  }
  
  // Mostrar indicador de carga
  const btnSubmit = document.getElementById('btnSubmit');
  btnSubmit.disabled = true;
  btnSubmit.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Creando pedido...';
});

// ========== ACCIONES ==========
function verDetallesPedido(id) {
  window.location.href = `/detalle-pedido-compra/${id}/`;
}

function verCotizaciones(id) {
  window.location.href = `/cotizaciones-pedido/${id}/`;
}

function editarPedido(id) {
  window.location.href = `/editar-pedido-compra/${id}/`;
}

function eliminarPedido(id, nombre) {
  const mensaje = `¿Estás seguro de eliminar el pedido "${nombre}"?\n\nEsta acción no se puede deshacer.`;
  if (confirm(mensaje)) {
    window.location.href = `/eliminar-pedido-compra/${id}/`;
  }
}
setTimeout(() => {
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(alert => {
    alert.style.animation = 'slideOut 0.3s forwards';
    setTimeout(() => alert.remove(), 300);
  });
}, 5000);
</script>

<style>
@keyframes slideOut {
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}
</style>

{% endblock %}