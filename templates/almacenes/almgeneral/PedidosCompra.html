{% extends 'layout.html' %}
{% load static %}

{% block title %}Pedidos de Compra - Sistema{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'almacenes/almgeneral/PedidosCompra.css' %}">

<div class="pedidos-container">
  
  <!-- Mensajes de feedback -->
  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      <i class="fa-solid {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %}"></i>
      {{ message }}
      <button class="btn-close-alert" onclick="this.parentElement.remove()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Header -->
  <div class="pedidos-header">
    <h1>
      <i class="fa-solid fa-clipboard-list"></i>
      Pedidos de Compra
    </h1>
    <a href="{% url 'CrearPedidoCompra' %}" class="btn-primary">
      <i class="fa-solid fa-plus"></i>
      Nuevo Pedido de Compra
    </a>
  </div>

  <!-- Filtros -->
  <div class="filtros-container">
    
    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-search"></i>
        Buscar
      </label>
      <input 
        type="text" 
        id="filtroBuscar" 
        class="filtro-input" 
        placeholder="Nombre, código o descripción..."
      >
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-filter"></i>
        Estado
      </label>
      <select id="filtroEstado" class="filtro-input">
        <option value="">Todos los estados</option>
        <option value="PEND">Pendiente</option>
        <option value="COMP">Completado</option>
        <option value="ENTR">Entregado</option>
      </select>
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-calendar"></i>
        Fecha Desde
      </label>
      <input 
        type="date" 
        id="filtroFechaDesde" 
        class="filtro-input"
      >
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-calendar"></i>
        Fecha Hasta
      </label>
      <input 
        type="date" 
        id="filtroFechaHasta" 
        class="filtro-input"
      >
    </div>

    <button class="btn-limpiar" onclick="limpiarFiltros()">
      <i class="fa-solid fa-eraser"></i>
      Limpiar
    </button>

  </div>

  <!-- Contador de resultados -->
  <div class="resultados-info">
    Mostrando <strong id="contadorResultados">{{ total_pedidos }}</strong> de <strong id="totalPedidos">{{ total_pedidos }}</strong> pedidos
  </div>

  <!-- Tabla de pedidos -->
  <div class="tabla-wrapper">
    <div class="tabla-container">
      <table class="tabla-pedidos">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Productos</th>
            <th>Archivo</th>
            <th>Estado</th>
            <th>Fecha Creación</th>
            <th>Última Modificación</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaBody">
          
          {% for pedido in pedidos %}
          <tr data-nombre="{{ pedido.nombre|lower }}" 
              data-codigo="{{ pedido.id_pedido }}"
              data-estado="{{ pedido.estado }}"
              data-fecha="{{ pedido.fecha_creacion|date:'Y-m-d' }}">
            
            <td data-label="Código">
              <strong>PC-{{ pedido.id_pedido|stringformat:"04d" }}</strong>
            </td>
            <td data-label="Nombre">{{ pedido.nombre }}</td>
            <td data-label="Descripción">{{ pedido.descripcion|truncatewords:8 }}</td>
            <td data-label="Productos" class="text-center">
              <span class="badge badge-info">
                <i class="fa-solid fa-boxes-stacked"></i>
                {{ pedido.total_items }} productos
              </span>
            </td>
            <td data-label="Archivo" class="archivo-cell">
              {% if pedido.archivo %}
              <a href="{{ pedido.archivo.url }}" target="_blank" class="archivo-link" title="Descargar archivo">
                <i class="fa-solid fa-file-{% if pedido.archivo.name|slice:'-3:' == 'pdf' %}pdf{% else %}word{% endif %}"></i>
                {{ pedido.archivo.name|slice:"-20:" }}
              </a>
              {% else %}
              <span class="sin-archivo">Sin archivo</span>
              {% endif %}
            </td>
            <td data-label="Estado">
              {% if pedido.estado == 'PEND' %}
                <span class="badge estado-pendiente">
                  <i class="fa-solid fa-clock"></i>
                  Pendiente
                </span>
              {% elif pedido.estado == 'COMP' %}
                <span class="badge estado-completado">
                  <i class="fa-solid fa-check"></i>
                  Completado
                </span>
              {% elif pedido.estado == 'ENTR' %}
                <span class="badge estado-entregado">
                  <i class="fa-solid fa-box-open"></i>
                  Entregado
                </span>
              {% endif %}
            </td>
            <td data-label="Fecha Creación">{{ pedido.fecha_creacion|date:"d/m/Y H:i" }}</td>
            <td data-label="Última Modificación">{{ pedido.fecha_modificacion|date:"d/m/Y H:i" }}</td>
            <td data-label="Acciones" class="acciones">
              <button class="btn-icon btn-info" 
                      title="Ver Detalles" 
                      data-id="{{ pedido.id_pedido }}"
                      onclick="verDetallesPedido(this.dataset.id)">
                <i class="fa-solid fa-eye"></i>
              </button>
              <button class="btn-icon btn-success" 
                      title="Ver Cotizaciones" 
                      data-id="{{ pedido.id_pedido }}"
                      onclick="verCotizaciones(this.dataset.id)">
                <i class="fa-solid fa-file-invoice-dollar"></i>
              </button>
              <button class="btn-icon btn-warning" 
                      title="Editar" 
                      data-id="{{ pedido.id_pedido }}"
                      onclick="editarPedido(this.dataset.id)">
                <i class="fa-solid fa-edit"></i>
              </button>
              <button class="btn-icon btn-danger" 
                      title="Eliminar" 
                      data-id="{{ pedido.id_pedido }}"
                      data-nombre="{{ pedido.nombre }}"
                      onclick="eliminarPedido(this.dataset.id, this.dataset.nombre)">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" style="text-align: center; padding: 3rem; color: #666;">
              <i class="fa-solid fa-inbox" style="font-size: 48px; margin-bottom: 1rem; display: block; color: #ccc;"></i>
              No hay pedidos de compra registrados
            </td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <!-- Mensaje si no hay resultados -->
  <div id="sinResultados" class="sin-resultados" style="display: none;">
    <i class="fa-solid fa-search"></i>
    <p>No se encontraron pedidos con los filtros seleccionados</p>
    <button class="btn-secondary" onclick="limpiarFiltros()">
      <i class="fa-solid fa-rotate-left"></i>
      Limpiar Filtros
    </button>
  </div>

</div>

<script>
// ========== FILTROS ==========
const filtroBuscar = document.getElementById('filtroBuscar');
const filtroEstado = document.getElementById('filtroEstado');
const filtroFechaDesde = document.getElementById('filtroFechaDesde');
const filtroFechaHasta = document.getElementById('filtroFechaHasta');
const tablaBody = document.getElementById('tablaBody');
const contadorResultados = document.getElementById('contadorResultados');
const totalPedidos = document.getElementById('totalPedidos');
const sinResultados = document.getElementById('sinResultados');

const totalFilas = tablaBody.querySelectorAll('tr[data-nombre]').length;
totalPedidos.textContent = totalFilas;

function filtrarTabla() {
  const buscar = filtroBuscar.value.toLowerCase();
  const estado = filtroEstado.value;
  const fechaDesde = filtroFechaDesde.value;
  const fechaHasta = filtroFechaHasta.value;
  
  const filas = tablaBody.querySelectorAll('tr[data-nombre]');
  let contador = 0;
  
  filas.forEach(fila => {
    const nombre = fila.getAttribute('data-nombre');
    const codigo = fila.getAttribute('data-codigo');
    const estadoFila = fila.getAttribute('data-estado');
    const fechaFila = fila.getAttribute('data-fecha');
    
    const cumpleBuscar = buscar === '' || nombre.includes(buscar) || codigo.includes(buscar);
    const cumpleEstado = estado === '' || estadoFila === estado;
    const cumpleFechaDesde = fechaDesde === '' || fechaFila >= fechaDesde;
    const cumpleFechaHasta = fechaHasta === '' || fechaFila <= fechaHasta;
    
    if (cumpleBuscar && cumpleEstado && cumpleFechaDesde && cumpleFechaHasta) {
      fila.style.display = '';
      contador++;
    } else {
      fila.style.display = 'none';
    }
  });
  
  contadorResultados.textContent = contador;
  
  if (contador === 0 && totalFilas > 0) {
    sinResultados.style.display = 'flex';
    document.querySelector('.tabla-wrapper').style.display = 'none';
  } else {
    sinResultados.style.display = 'none';
    document.querySelector('.tabla-wrapper').style.display = 'block';
  }
}

filtroBuscar.addEventListener('input', filtrarTabla);
filtroEstado.addEventListener('change', filtrarTabla);
filtroFechaDesde.addEventListener('change', filtrarTabla);
filtroFechaHasta.addEventListener('change', filtrarTabla);

function limpiarFiltros() {
  filtroBuscar.value = '';
  filtroEstado.value = '';
  filtroFechaDesde.value = '';
  filtroFechaHasta.value = '';
  filtrarTabla();
}

// ========== ACCIONES ==========
function verDetallesPedido(id) {
  window.location.href = `/detalle-pedido-compra/${id}/`;
}

function verCotizaciones(id) {
  window.location.href = `/cotizaciones-pedido/${id}/`;
}

function editarPedido(id) {
  window.location.href = `/editar-pedido-compra/${id}/`;
}

function eliminarPedido(id, nombre) {
  const mensaje = `¿Estás seguro de eliminar el pedido "${nombre}"?\n\nEsta acción no se puede deshacer.`;
  if (confirm(mensaje)) {
    window.location.href = `/eliminar-pedido-compra/${id}/`;
  }
}

// Auto-ocultar alertas
setTimeout(() => {
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(alert => {
    alert.style.animation = 'slideOut 0.3s forwards';
    setTimeout(() => alert.remove(), 300);
  });
}, 5000);
</script>

<style>
@keyframes slideOut {
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

.text-center {
  text-align: center;
}

.badge-info {
  background: #2196f3;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

/* ========== FILTROS MEJORADOS (SIN SOBREPOSICIÓN) ========== */
.filtros-container {
  display: grid;
  grid-template-columns: 2fr 1.5fr 1.5fr 1.5fr auto;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding: 1.5rem;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  align-items: end;
}

.filtro-grupo {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  min-width: 0; /* Importante para evitar overflow */
}

.filtro-grupo label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
  font-size: 0.875rem;
  color: #333;
  white-space: nowrap;
}

.filtro-grupo label i {
  color: #666;
  font-size: 0.875rem;
}

.filtro-input {
  width: 100%;
  padding: 0.625rem 0.875rem;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  background: white;
  box-sizing: border-box;
}

.filtro-input:focus {
  outline: none;
  border-color: #4caf50;
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.btn-limpiar {
  padding: 0.625rem 1.25rem;
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  white-space: nowrap;
  height: fit-content;
}

.btn-limpiar:hover {
  background: #e0e0e0;
  border-color: #bbb;
}

.btn-limpiar i {
  font-size: 0.875rem;
}

/* ========== RESPONSIVE PARA FILTROS ========== */

/* Tablets grandes */
@media screen and (max-width: 1400px) {
  .filtros-container {
    grid-template-columns: 1.5fr 1fr 1fr 1fr auto;
    gap: 0.875rem;
  }
}

/* Tablets */
@media screen and (max-width: 1024px) {
  .filtros-container {
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  
  .btn-limpiar {
    grid-column: 1 / -1;
    justify-content: center;
  }
}

/* Móviles */
@media screen and (max-width: 768px) {
  .filtros-container {
    grid-template-columns: 1fr;
    gap: 1rem;
    padding: 1rem;
  }
  
  .filtro-grupo label {
    font-size: 0.8rem;
  }
  
  .filtro-input {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
  }
}

/* ========== TABLA RESPONSIVE ========== */
.tabla-wrapper {
  width: 100%;
  overflow: hidden;
}

.tabla-container {
  width: 100%;
  overflow-x: auto;
  overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.tabla-pedidos {
  width: 100%;
  min-width: 1200px;
  border-collapse: collapse;
}

.tabla-pedidos thead {
  background: #f8f9fa;
  border-bottom: 2px solid #e0e0e0;
}

.tabla-pedidos th {
  padding: 1rem;
  text-align: left;
  font-weight: 600;
  color: #333;
  font-size: 0.875rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.tabla-pedidos tbody tr {
  border-bottom: 1px solid #f0f0f0;
  transition: background-color 0.2s ease;
}

.tabla-pedidos tbody tr:hover {
  background-color: #f8f9fa;
}

.tabla-pedidos td {
  padding: 1rem;
  font-size: 0.9rem;
  color: #555;
}

/* Ajustes para tablets */
@media screen and (max-width: 1200px) {
  .tabla-pedidos {
    min-width: 1000px;
    font-size: 14px;
  }
  
  .tabla-pedidos th,
  .tabla-pedidos td {
    padding: 10px 8px;
  }
}

/* Ajustes para pantallas móviles - Vista de tarjetas */
@media screen and (max-width: 768px) {
  .tabla-wrapper {
    overflow: visible;
  }
  
  .tabla-container {
    overflow-x: visible;
    box-shadow: none;
    background: transparent;
  }
  
  .tabla-pedidos {
    min-width: 100%;
  }
  
  .tabla-pedidos thead {
    display: none;
  }
  
  .tabla-pedidos tbody tr {
    display: block;
    margin-bottom: 1rem;
    border: 1px solid #ddd;
    border-radius: 12px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  
  .tabla-pedidos tbody td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    text-align: right;
  }
  
  .tabla-pedidos tbody td:last-child {
    border-bottom: none;
  }
  
  .tabla-pedidos tbody td::before {
    content: attr(data-label);
    font-weight: 600;
    text-align: left;
    flex: 1;
    color: #333;
    font-size: 0.85rem;
  }
  
  .tabla-pedidos tbody td .badge {
    margin-left: auto;
  }
  
  .acciones {
    justify-content: flex-end;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .acciones::before {
    flex: 1 1 100%;
    margin-bottom: 8px;
  }
  
  .btn-icon {
    margin: 0 4px;
  }
}

/* Ajustes para móviles muy pequeños */
@media screen and (max-width: 480px) {
  .pedidos-header {
    flex-direction: column;
    gap: 1rem;
  }
  
  .pedidos-header h1 {
    font-size: 1.5rem;
  }
  
  .tabla-pedidos tbody td {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .tabla-pedidos tbody td::before {
    margin-bottom: 4px;
  }
  
  .acciones {
    width: 100%;
    justify-content: center;
  }
}

/* ========== HEADER RESPONSIVE ========== */
.pedidos-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  gap: 1rem;
}

@media screen and (max-width: 640px) {
  .pedidos-header {
    flex-direction: column;
    align-items: stretch;
  }
  
  .pedidos-header h1 {
    text-align: center;
  }
  
  .btn-primary {
    width: 100%;
    justify-content: center;
  }
}
</style>

{% endblock %}