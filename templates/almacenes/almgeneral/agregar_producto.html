{% extends 'layout.html' %}
{% load static %}

{% block title %}Agregar Producto - Sistema{% endblock %}

{% block content %}
<style>
.form-container {
  max-width: 900px;
  margin: 0 auto;
  padding: 30px;
}

.form-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid #e0e0e0;
}

.form-header h1 {
  font-size: 28px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 0;
}

.form-header h1 i {
  color: #148129;
}

.btn-back {
  background: #f5f5f5;
  color: #666;
  border: 1px solid #ddd;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  text-decoration: none;
}

.btn-back:hover {
  background: #e0e0e0;
  color: #333;
}

.form-card {
  background: white;
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.form-group label i {
  color: #148129;
  font-size: 12px;
}

.form-group label .required {
  color: #d32f2f;
  margin-left: 2px;
}

.form-input,
.form-select,
.form-textarea {
  padding: 12px 15px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.3s;
  font-family: inherit;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: #148129;
  box-shadow: 0 0 0 3px rgba(20,129,41,0.1);
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
}

.unidad-group {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.unidad-group .form-select {
  flex: 1;
}

.btn-nueva-unidad {
  background: #148129;
  color: white;
  border: none;
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
  white-space: nowrap;
}

.btn-nueva-unidad:hover {
  background: #0f6621;
  transform: translateY(-1px);
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid #e0e0e0;
}

.btn-submit {
  background: #148129;
  color: white;
  border: none;
  padding: 12px 30px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
}

.btn-submit:hover {
  background: #0f6621;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(20,129,41,0.3);
}

.btn-cancel {
  background: transparent;
  color: #666;
  border: 1px solid #ddd;
  padding: 12px 30px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  transition: all 0.3s;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-cancel:hover {
  background: #f5f5f5;
  border-color: #999;
  color: #333;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 12px;
  padding: 30px;
  max-width: 500px;
  width: 90%;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}

.modal-header h2 {
  font-size: 22px;
  color: #333;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  background: transparent;
  border: none;
  font-size: 24px;
  color: #999;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all 0.2s;
}

.modal-close:hover {
  background: #f5f5f5;
  color: #333;
}

.alert {
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.alert-success {
  background: #e8f5e9;
  color: #148129;
  border-left: 4px solid #148129;
}

.alert-error {
  background: #ffebee;
  color: #d32f2f;
  border-left: 4px solid #d32f2f;
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .form-header {
    flex-direction: column;
    gap: 15px;
    align-items: flex-start;
  }
}
</style>

<div class="form-container">
  
  <!-- Header -->
  <div class="form-header">
    <h1>
      <i class="fa-solid fa-plus-circle"></i>
      Agregar Nuevo Producto
    </h1>
    <a href="{% url 'InventarioAG' %}" class="btn-back">
      <i class="fa-solid fa-arrow-left"></i>
      Volver al Inventario
    </a>
  </div>

  <!-- Mensajes -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">
        <i class="fa-solid fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Formulario -->
  <div class="form-card">
    <form method="POST" id="formProducto">
      {% csrf_token %}

      <div class="form-grid">
        
        <!-- Nombre del Producto -->
        <div class="form-group">
          <label>
            <i class="fa-solid fa-signature"></i>
            Nombre del Producto
            <span class="required">*</span>
          </label>
          <input 
            type="text" 
            name="nombre" 
            class="form-input" 
            placeholder="Ej: Martillo"
            required
          >
        </div>

        <!-- Ubicación Almacén -->
        <div class="form-group">
          <label>
            <i class="fa-solid fa-warehouse"></i>
            Ubicación Almacén
            <span class="required">*</span>
          </label>
          <select name="ubicacion_almacen" class="form-select" required>
            <option value="">Seleccionar almacén</option>
            <option value="AG">Almacén General</option>
            <option value="AD">Almacén de Deporte</option>
            <option value="ID">Imprenta Deportes</option>
          </select>
        </div>

        <!-- Descripción -->
        <div class="form-group full-width">
          <label>
            <i class="fa-solid fa-align-left"></i>
            Descripción Detallada
            <span class="required">*</span>
          </label>
          <input 
            type="text" 
            name="descripcion" 
            class="form-input" 
            placeholder="Ej: Martillo de goma antideslizante con mango ergonómico"
            required
          >
        </div>

        <!-- Estante -->
        <div class="form-group">
          <label>
            <i class="fa-solid fa-location-dot"></i>
            Estante
            <span class="required">*</span>
          </label>
          <input 
            type="text" 
            name="estante" 
            class="form-input" 
            placeholder="Ej: A3, B1, C2"
            required
          >
        </div>

        <!-- Cantidad -->
        <div class="form-group">
          <label>
            <i class="fa-solid fa-boxes-stacked"></i>
            Cantidad
            <span class="required">*</span>
          </label>
          <input 
            type="number" 
            name="cantidad" 
            class="form-input" 
            placeholder="0"
            min="0"
            required
          >
        </div>

        <!-- Unidad -->
        <div class="form-group">
          <label>
            <i class="fa-solid fa-ruler"></i>
            Unidad de Medida
            <span class="required">*</span>
          </label>
          <div class="unidad-group">
            <select name="unidad" id="selectUnidad" class="form-select" required>
              <option value="">Seleccionar unidad</option>
              {% for unidad in unidades %}
                <option value="{{ unidad.nombre }}">{{ unidad.nombre }}</option>
              {% endfor %}
            </select>
            <button type="button" class="btn-nueva-unidad" onclick="abrirModalUnidad()">
              <i class="fa-solid fa-plus"></i>
              Nueva
            </button>
          </div>
        </div>

        <!-- Estado -->
        <div class="form-group full-width">
          <label>
            <i class="fa-solid fa-circle-check"></i>
            Estado
            <span class="required">*</span>
          </label>
          <select name="estado" class="form-select" required>
            <option value="">Seleccionar estado</option>
            <option value="DISP">Disponible</option>
            <option value="BAJO">Stock Bajo</option>
            <option value="AGOT">Agotado</option>
          </select>
        </div>

        <!-- Observaciones -->
        <div class="form-group full-width">
          <label>
            <i class="fa-solid fa-comment"></i>
            Observaciones
          </label>
          <textarea 
            name="observaciones" 
            class="form-textarea"
            placeholder="Información adicional sobre el producto..."
          ></textarea>
        </div>

      </div>

      <!-- Acciones -->
      <div class="form-actions">
        <a href="{% url 'InventarioAG' %}" class="btn-cancel">
          <i class="fa-solid fa-times"></i>
          Cancelar
        </a>
        <button type="submit" class="btn-submit">
          <i class="fa-solid fa-save"></i>
          Guardar Producto
        </button>
      </div>

    </form>
  </div>

</div>

<!-- Modal para crear unidad -->
<div id="modalUnidad" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>
        <i class="fa-solid fa-plus-circle"></i>
        Crear Nueva Unidad
      </h2>
      <button type="button" class="modal-close" onclick="cerrarModalUnidad()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <form id="formUnidad">
      {% csrf_token %}
      
      <div class="form-group">
        <label>
          <i class="fa-solid fa-ruler"></i>
          Nombre de la Unidad
          <span class="required">*</span>
        </label>
        <input 
          type="text" 
          id="nombreUnidad" 
          class="form-input" 
          placeholder="Ej: Piezas, Cajas, Litros"
          required
        >
      </div>

      <div class="form-group">
        <label>
          <i class="fa-solid fa-font"></i>
          Abreviatura (opcional)
        </label>
        <input 
          type="text" 
          id="abreviaturaUnidad" 
          class="form-input" 
          placeholder="Ej: pzs, cjs, lts"
          maxlength="10"
        >
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" onclick="cerrarModalUnidad()">
          Cancelar
        </button>
        <button type="button" class="btn-submit" onclick="crearUnidad()">
          <i class="fa-solid fa-save"></i>
          Crear Unidad
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Abrir modal
function abrirModalUnidad() {
  document.getElementById('modalUnidad').classList.add('active');
  document.getElementById('nombreUnidad').focus();
}

// Cerrar modal
function cerrarModalUnidad() {
  document.getElementById('modalUnidad').classList.remove('active');
  document.getElementById('formUnidad').reset();
}

// Cerrar modal al hacer clic fuera
document.getElementById('modalUnidad').addEventListener('click', function(e) {
  if (e.target === this) {
    cerrarModalUnidad();
  }
});

// Crear unidad mediante AJAX
function crearUnidad() {
  const nombre = document.getElementById('nombreUnidad').value.trim();
  const abreviatura = document.getElementById('abreviaturaUnidad').value.trim();
  
  if (!nombre) {
    alert('Por favor ingresa el nombre de la unidad');
    return;
  }

  // Obtener el token CSRF
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch('/almacenes/crear-unidad/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrftoken
    },
    body: JSON.stringify({
      nombre: nombre,
      abreviatura: abreviatura
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Agregar la nueva unidad al select
      const select = document.getElementById('selectUnidad');
      const option = document.createElement('option');
      option.value = data.unidad.nombre;
      option.text = data.unidad.nombre;
      option.selected = true;
      select.appendChild(option);
      
      // Cerrar modal
      cerrarModalUnidad();
      
      // Mostrar mensaje de éxito
      alert('Unidad creada exitosamente');
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al crear la unidad');
  });
}

// Enter para enviar en el modal
document.getElementById('nombreUnidad').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    crearUnidad();
  }
});
</script>

{% endblock %}