{% extends 'layout.html' %}
{% load static %}

{% block title %}Editar Pedido - {{ pedido.nombre }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'almacenes/almgeneral/PedidosCompra.css' %}">

<div class="pedidos-container">
  
  <!-- Mensajes -->
  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      <i class="fa-solid {% if message.tags == 'success' %}fa-check-circle{% elif message.tags == 'error' %}fa-exclamation-circle{% endif %}"></i>
      {{ message }}
      <button class="btn-close-alert" onclick="this.parentElement.remove()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Header -->
  <div class="pedidos-header">
    <h1>
      <i class="fa-solid fa-edit"></i>
      Editar Pedido - {{ pedido.nombre }}
    </h1>
    <button class="btn-secondary" onclick="window.location.href='{% url 'PedidosCompra' %}'">
      <i class="fa-solid fa-arrow-left"></i>
      Volver
    </button>
  </div>

  <!-- Formulario de Información General -->
  <div class="form-card">
    <form method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <div class="form-section">
        <h3><i class="fa-solid fa-info-circle"></i> Información del Pedido</h3>
        
        <div class="form-row">
          <div class="form-group">
            <label>
              <i class="fa-solid fa-tag"></i>
              Nombre del Pedido *
            </label>
            <input 
              type="text" 
              name="nombre" 
              class="form-input" 
              value="{{ pedido.nombre }}"
              required
            >
          </div>

          <div class="form-group">
            <label>
              <i class="fa-solid fa-list-check"></i>
              Estado *
            </label>
            <select name="estado" class="form-input" required>
              <option value="PEND" {% if pedido.estado == 'PEND' %}selected{% endif %}>Pendiente</option>
              <option value="COMP" {% if pedido.estado == 'COMP' %}selected{% endif %}>Completado</option>
              <option value="ENTR" {% if pedido.estado == 'ENTR' %}selected{% endif %}>Entregado</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>
            <i class="fa-solid fa-align-left"></i>
            Descripción
          </label>
          <textarea 
            name="descripcion" 
            class="form-input" 
            rows="4"
          >{{ pedido.descripcion }}</textarea>
        </div>

        <div class="form-group">
          <label>
            <i class="fa-solid fa-file-upload"></i>
            Archivo del Pedido
          </label>
          
          {% if pedido.archivo %}
          <div class="archivo-actual">
            <i class="fa-solid fa-file-pdf"></i>
            <span>Archivo actual: {{ pedido.archivo.name|slice:"-40:" }}</span>
            <a href="{{ pedido.archivo.url }}" target="_blank" class="btn-ver">
              <i class="fa-solid fa-eye"></i>
              Ver
            </a>
          </div>
          {% else %}
          <div class="archivo-actual sin-archivo">
            <i class="fa-solid fa-file-circle-xmark"></i>
            <span>No hay archivo adjunto</span>
          </div>
          {% endif %}

          <div class="file-upload-wrapper">
            <input 
              type="file" 
              name="archivo" 
              id="archivoInput"
              class="file-input" 
              accept=".pdf,.doc,.docx"
            >
            <label for="archivoInput" class="file-label">
              <i class="fa-solid fa-cloud-upload-alt"></i>
              <span id="fileNameDisplay">Subir nuevo archivo (opcional)</span>
            </label>
          </div>
          <small class="file-hint">
            <i class="fa-solid fa-info-circle"></i>
            Si no subes un nuevo archivo, se mantendrá el actual
          </small>
        </div>

      </div>

      <!-- Información de fechas -->
      <div class="form-section info-section">
        <h3><i class="fa-solid fa-clock"></i> Información de Fechas</h3>
        <div class="info-grid">
          <div class="info-item">
            <label>Fecha de Creación:</label>
            <span>{{ pedido.fecha_creacion|date:"d/m/Y H:i" }}</span>
          </div>
          <div class="info-item">
            <label>Última Modificación:</label>
            <span class="text-modified">{{ pedido.fecha_modificacion|date:"d/m/Y H:i" }}</span>
          </div>
        </div>
      </div>

      <div class="form-footer">
        <button type="button" class="btn-secondary" onclick="window.location.href='{% url 'PedidosCompra' %}'">
          <i class="fa-solid fa-times"></i>
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          <i class="fa-solid fa-save"></i>
          Guardar Cambios
        </button>
      </div>

    </form>
  </div>

  <!-- Sección de Items/Productos del Pedido -->
  <div class="form-card" style="margin-top: 20px;">
    <div class="form-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 style="margin: 0;">
          <i class="fa-solid fa-boxes"></i> 
          Items del Pedido ({{ pedido.items.count }})
        </h3>
        <button type="button" class="btn-primary" onclick="mostrarModalAgregarItem()">
          <i class="fa-solid fa-plus"></i>
          Agregar Producto
        </button>
      </div>

      <!-- Tabla de Items -->
      <div class="table-responsive">
        <table class="items-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
              <th>Observaciones</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="itemsTableBody">
            {% for item in pedido.items.all %}
            <tr data-item-id="{{ item.id_item }}">
              <td>{{ forloop.counter }}</td>
              <td>
                <strong>{{ item.producto.nombre }}</strong>
                <small style="display: block; color: #6c757d;">{{ item.producto.codigo }}</small>
              </td>
              <td>{{ item.cantidad_solicitada }}</td>
              <td>S/ {{ item.precio_unitario|floatformat:2 }}</td>
              <td><strong>S/ {{ item.subtotal|floatformat:2 }}</strong></td>
              <td>{{ item.observaciones|default:"—" }}</td>
              <td>
                <div class="action-buttons">
                  <button type="button" class="btn-icon btn-edit" onclick="editarItem({{ item.id_item }})" title="Editar">
                    <i class="fa-solid fa-edit"></i>
                  </button>
                  <button type="button" class="btn-icon btn-delete" onclick="eliminarItem({{ item.id_item }}, '{{ item.producto.nombre }}')" title="Eliminar">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="empty-state">
                <i class="fa-solid fa-inbox"></i>
                <p>No hay productos en este pedido</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td colspan="4" style="text-align: right;"><strong>TOTAL GENERAL:</strong></td>
              <td colspan="3"><strong style="color: #148129; font-size: 18px;">S/ {{ pedido.total_general|floatformat:2 }}</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal para Agregar/Editar Item -->
<div id="modalItem" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">
        <i class="fa-solid fa-plus-circle"></i>
        Agregar Producto
      </h2>
      <button class="btn-close-modal" onclick="cerrarModal()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
    
    <form id="formItem" method="POST" action="">
      {% csrf_token %}
      <input type="hidden" id="itemId" name="item_id">
      
      <div class="modal-body">
        <div class="form-group">
          <label>
            <i class="fa-solid fa-box"></i>
            Producto *
          </label>
          <select name="producto_id" id="productoSelect" class="form-input" required>
            <option value="">Seleccione un producto...</option>
            {% for producto in productos %}
            <option value="{{ producto.id_producto }}" data-precio="{{ producto.precio_venta|default:0 }}">
              {{ producto.nombre }} - {{ producto.codigo }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>
              <i class="fa-solid fa-hashtag"></i>
              Cantidad *
            </label>
            <input 
              type="number" 
              name="cantidad" 
              id="cantidadInput"
              class="form-input" 
              min="1"
              required
              oninput="calcularSubtotal()"
            >
          </div>

          <div class="form-group">
            <label>
              <i class="fa-solid fa-dollar-sign"></i>
              Precio Unitario *
            </label>
            <input 
              type="number" 
              name="precio_unitario" 
              id="precioInput"
              class="form-input" 
              step="0.01"
              min="0"
              required
              oninput="calcularSubtotal()"
            >
          </div>
        </div>

        <div class="form-group">
          <label>
            <i class="fa-solid fa-calculator"></i>
            Subtotal
          </label>
          <input 
            type="text" 
            id="subtotalDisplay"
            class="form-input" 
            readonly
            style="background: #f1f8f4; font-weight: bold; color: #148129;"
            value="S/ 0.00"
          >
        </div>

        <div class="form-group">
          <label>
            <i class="fa-solid fa-comment"></i>
            Observaciones
          </label>
          <textarea 
            name="observaciones" 
            id="observacionesInput"
            class="form-input" 
            rows="3"
          ></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="cerrarModal()">
          <i class="fa-solid fa-times"></i>
          Cancelar
        </button>
        <button type="submit" class="btn-primary">
          <i class="fa-solid fa-save"></i>
          Guardar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Variables globales
const modal = document.getElementById('modalItem');
const formItem = document.getElementById('formItem');
const productoSelect = document.getElementById('productoSelect');
const cantidadInput = document.getElementById('cantidadInput');
const precioInput = document.getElementById('precioInput');
const subtotalDisplay = document.getElementById('subtotalDisplay');

// Auto-rellenar precio al seleccionar producto
productoSelect.addEventListener('change', function() {
  const selectedOption = this.options[this.selectedIndex];
  const precio = selectedOption.dataset.precio || 0;
  precioInput.value = parseFloat(precio).toFixed(2);
  calcularSubtotal();
});

// Calcular subtotal
function calcularSubtotal() {
  const cantidad = parseFloat(cantidadInput.value) || 0;
  const precio = parseFloat(precioInput.value) || 0;
  const subtotal = cantidad * precio;
  subtotalDisplay.value = 'S/ ' + subtotal.toFixed(2);
}

// Mostrar modal para agregar
function mostrarModalAgregarItem() {
  document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-plus-circle"></i> Agregar Producto';
  formItem.action = "{% url 'AgregarItemPedido' pedido.id_pedido %}";
  document.getElementById('itemId').value = '';
  formItem.reset();
  subtotalDisplay.value = 'S/ 0.00';
  modal.style.display = 'flex';
}

// Editar item
function editarItem(itemId) {
  // Hacer petición AJAX para obtener datos del item
  fetch(`/pedidos-compra/item/${itemId}/obtener/`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-edit"></i> Editar Producto';
      formItem.action = "{% url 'EditarItemPedido' pedido.id_pedido %}";
      document.getElementById('itemId').value = itemId;
      productoSelect.value = data.producto_id;
      cantidadInput.value = data.cantidad;
      precioInput.value = data.precio_unitario;
      document.getElementById('observacionesInput').value = data.observaciones || '';
      calcularSubtotal();
      modal.style.display = 'flex';
    })
    .catch(error => {
      alert('Error al cargar los datos del item');
      console.error(error);
    });
}

// Eliminar item
function eliminarItem(itemId, nombreProducto) {
  if (confirm(`¿Eliminar "${nombreProducto}" del pedido?`)) {
    fetch(`/pedidos-compra/item/${itemId}/eliminar/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      alert('Error al eliminar el item');
      console.error(error);
    });
  }
}

// Cerrar modal
function cerrarModal() {
  modal.style.display = 'none';
  formItem.reset();
}

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
  if (event.target == modal) {
    cerrarModal();
  }
}

// Manejo de archivo principal
const archivoInput = document.getElementById('archivoInput');
const fileNameDisplay = document.getElementById('fileNameDisplay');

archivoInput.addEventListener('change', function(e) {
  const file = e.target.files[0];
  
  if (file) {
    const maxSize = 10 * 1024 * 1024;
    if (file.size > maxSize) {
      alert('El archivo es demasiado grande. Máximo 10MB permitido.');
      archivoInput.value = '';
      fileNameDisplay.textContent = 'Subir nuevo archivo (opcional)';
      return;
    }
    
    const extension = file.name.split('.').pop().toLowerCase();
    const tiposPermitidos = ['pdf', 'doc', 'docx'];
    
    if (!tiposPermitidos.includes(extension)) {
      alert('Formato no permitido. Solo se aceptan archivos PDF, DOC o DOCX.');
      archivoInput.value = '';
      fileNameDisplay.textContent = 'Subir nuevo archivo (opcional)';
      return;
    }
    
    fileNameDisplay.innerHTML = `<i class="fa-solid fa-file-${extension === 'pdf' ? 'pdf' : 'word'}"></i> ${file.name}`;
  }
});

// Auto-cerrar mensajes
setTimeout(() => {
  const alerts = document.querySelectorAll('.alert');
  alerts.forEach(alert => {
    alert.style.animation = 'slideOut 0.3s forwards';
    setTimeout(() => alert.remove(), 300);
  });
}, 5000);
</script>

<style>
/* Estilos existentes... */
.form-card {
  background: white;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid #e0e0e0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.form-section {
  padding: 30px;
  border-bottom: 1px solid #f0f0f0;
}

.form-section:last-of-type {
  border-bottom: none;
}

.form-section h3 {
  color: #148129;
  margin: 0 0 24px 0;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.archivo-actual {
  background: #f1f8f4;
  border: 2px solid #d4edda;
  border-radius: 10px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.archivo-actual.sin-archivo {
  background: #fff3cd;
  border-color: #ffc107;
}

.archivo-actual i {
  font-size: 24px;
  color: #148129;
}

.archivo-actual.sin-archivo i {
  color: #856404;
}

.archivo-actual span {
  flex: 1;
  color: #333;
  font-weight: 500;
}

.btn-ver {
  padding: 8px 16px;
  background: #148129;
  color: white;
  border-radius: 8px;
  text-decoration: none;
  font-size: 14px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
}

.btn-ver:hover {
  background: #0d5a1d;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(20, 129, 41, 0.3);
}

.info-section {
  background: #f8f9fa;
}

.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}

.info-item {
  background: white;
  padding: 16px;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.info-item label {
  display: block;
  font-weight: 600;
  color: #666;
  font-size: 13px;
  margin-bottom: 8px;
}

.info-item span {
  display: block;
  font-size: 15px;
  color: #333;
  font-weight: 500;
}

.text-modified {
  color: #148129 !important;
  font-style: italic;
}

/* Tabla de Items */
.items-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}

.items-table thead {
  background: linear-gradient(135deg, #148129 0%, #0d5a1d 100%);
  color: white;
}

.items-table th {
  padding: 12px;
  text-align: left;
  font-weight: 600;
  font-size: 13px;
}

.items-table td {
  padding: 12px;
  border-bottom: 1px solid #f0f0f0;
  vertical-align: middle;
}

.items-table tbody tr:hover {
  background-color: #f8fdf9;
}

.total-row {
  background: #f1f8f4;
  font-weight: bold;
}

.total-row td {
  padding: 16px 12px;
  border-top: 2px solid #148129;
}

.action-buttons {
  display: flex;
  gap: 8px;
}

.btn-icon {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
  font-size: 13px;
}

.btn-edit {
  background: #17a2b8;
  color: white;
}

.btn-edit:hover {
  background: #138496;
  transform: translateY(-2px);
}

.btn-delete {
  background: #dc3545;
  color: white;
}

.btn-delete:hover {
  background: #c82333;
  transform: translateY(-2px);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
  align-items: center;
  justify-content: center;
}

.modal-content {
  background-color: white;
  border-radius: 16px;
  width: 90%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 24px 30px;
  border-bottom: 2px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h2 {
  margin: 0;
  color: #148129;
  font-size: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn-close-modal {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6c757d;
  transition: color 0.3s;
}

.btn-close-modal:hover {
  color: #dc3545;
}

.modal-body {
  padding: 30px;
}

.modal-footer {
  padding: 20px 30px;
  border-top: 2px solid #f0f0f0;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  background: #f8f9fa;
}

.form-footer {
  padding: 24px 30px;
  background: #f8f9fa;
  border-top: 2px solid #e0e0e0;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #6c757d;
}

.empty-state i {
  font-size: 48px;
  color: #dee2e6;
  margin-bottom: 12px;
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }

  .form-footer, .modal-footer {
    flex-direction: column;
  }

  .form-footer button, .modal-footer button {
    width: 100%;
  }
}
</style>

{% endblock %}