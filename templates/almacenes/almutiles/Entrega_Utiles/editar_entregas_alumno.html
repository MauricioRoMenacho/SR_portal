{% extends 'layout.html' %}
{% load static %}

{% block title %}Editar Entregas - {{ alumno.nombre }}{% endblock %}

{% block content %}
<style>
    .editar-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 30px;
    }

    .header-editar {
        background: white;
        padding: 20px 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-editar h1 {
        font-size: 22px;
        margin: 0 0 4px 0;
        color: #333;
    }

    .header-editar p {
        margin: 0;
        color: #666;
        font-size: 14px;
    }

    .btn-back-link {
        padding: 10px 20px;
        background: #f0f0f0;
        border-radius: 8px;
        text-decoration: none;
        color: #333;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

    .btn-back-link:hover {
        background: #e0e0e0;
    }

    .form-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .form-header {
        padding: 20px 24px;
        background: #f9f9f9;
        border-bottom: 1px solid #e0e0e0;
    }

    .form-header h2 {
        margin: 0;
        font-size: 18px;
        color: #333;
    }

    .form-body {
        padding: 24px;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ğŸ”§ NUEVA TABLA DE ENTREGAS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .entregas-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .entregas-table thead {
        background: #f9f9f9;
        border-bottom: 2px solid #e0e0e0;
    }

    .entregas-table th {
        padding: 14px 16px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .entregas-table th:nth-child(1) { width: 40px; }      /* # */
    .entregas-table th:nth-child(2) { width: auto; }      /* Ãštil */
    .entregas-table th:nth-child(3) { width: 100px; text-align: center; } /* Pedido */
    .entregas-table th:nth-child(4) { width: 140px; text-align: center; } /* Entregado */
    .entregas-table th:nth-child(5) { width: 120px; text-align: center; } /* Estado */
    .entregas-table th:nth-child(6) { width: 280px; }     /* Observaciones */

    .entregas-table tbody tr {
        border-bottom: 1px solid #eee;
        transition: all 0.2s;
    }

    .entregas-table tbody tr:hover {
        background: #f1f8f4;
    }

    .entregas-table td {
        padding: 16px;
        font-size: 14px;
        color: #333;
        vertical-align: middle;
    }

    /* Columna de nÃºmero */
    .row-number {
        color: #999;
        font-size: 13px;
        font-weight: 600;
    }

    /* Columna de Ãºtil */
    .util-info h3 {
        font-size: 15px;
        margin: 0 0 4px 0;
        color: #333;
        font-weight: 600;
    }

    .util-info p {
        margin: 0;
        font-size: 12px;
        color: #999;
    }

    .util-info .fecha-entrega {
        margin-top: 6px;
        font-size: 12px;
        color: #148129;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    /* Columna de cantidad pedida */
    .cantidad-pedida {
        text-align: center;
        font-size: 18px;
        font-weight: 700;
        color: #666;
    }

    /* ğŸ”§ NUEVO: Control de cantidad entregada */
    .cantidad-control {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .cantidad-btn {
        width: 32px;
        height: 32px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 700;
        color: #666;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cantidad-btn:hover {
        border-color: #148129;
        color: #148129;
        background: #f1f8f4;
    }

    .cantidad-btn:active {
        transform: scale(0.95);
    }

    .cantidad-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
        border-color: #ddd;
        color: #999;
    }

    .cantidad-btn:disabled:hover {
        background: white;
    }

    .cantidad-input {
        width: 60px;
        height: 36px;
        text-align: center;
        font-size: 16px;
        font-weight: 700;
        border: 2px solid #ddd;
        border-radius: 6px;
        color: #333;
        transition: all 0.2s;
    }

    .cantidad-input:focus {
        outline: none;
        border-color: #148129;
        box-shadow: 0 0 0 3px rgba(20, 129, 41, 0.1);
    }

    /* Indicador visual de progreso */
    .cantidad-input.completo {
        border-color: #148129;
        background: #f0fff4;
        color: #148129;
    }

    .cantidad-input.parcial {
        border-color: #fbbf24;
        background: #fffbeb;
        color: #92400e;
    }

    .cantidad-input.vacio {
        border-color: #ddd;
        background: white;
    }

    /* Columna de estado visual */
    .estado-visual {
        text-align: center;
    }

    .badge-estado {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-estado.completo {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-estado.parcial {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-estado.pendiente {
        background: #f3f4f6;
        color: #6b7280;
    }

    /* Columna de observaciones */
    .obs-textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 13px;
        resize: vertical;
        min-height: 50px;
        font-family: inherit;
    }

    .obs-textarea:focus {
        outline: none;
        border-color: #148129;
        box-shadow: 0 0 0 3px rgba(20, 129, 41, 0.1);
    }

    .obs-textarea::placeholder {
        color: #bbb;
    }

    .form-footer {
        padding: 20px 24px;
        background: #f9f9f9;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        text-decoration: none;
    }

    .btn-cancel {
        background: #f0f0f0;
        color: #333;
    }

    .btn-cancel:hover {
        background: #e0e0e0;
    }

    .btn-submit {
        background: #148129;
        color: white;
    }

    .btn-submit:hover {
        background: #106020;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(20, 129, 41, 0.3);
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state i {
        font-size: 64px;
        margin-bottom: 16px;
        display: block;
        color: #ddd;
    }

    .messages {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }

    .messages li {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .messages .success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }

    @media (max-width: 768px) {
        .editar-container {
            padding: 15px;
        }

        .header-editar {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }

        .entregas-table {
            font-size: 12px;
        }

        .entregas-table th,
        .entregas-table td {
            padding: 10px 8px;
        }

        .cantidad-input {
            width: 50px;
        }
    }
</style>

<div class="editar-container">
    <div class="header-editar">
        <div>
            <h1>Editar Entregas - {{ alumno.nombre }}</h1>
            <p>{{ salon.nombre }} - {{ salon.get_grado_display }}</p>
        </div>
        <a href="{% url 'detalle_alumno' alumno.pk %}" class="btn-back-link">
            <i class="fa-solid fa-arrow-left"></i> Volver
        </a>
    </div>

    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li class="{{ message.tags }}">
            <i class="fa-solid fa-check-circle"></i>
            {{ message }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if entregas %}
    <form method="post" class="form-card">
        {% csrf_token %}
        
        <div class="form-header">
            <h2><i class="fa-solid fa-clipboard-check"></i> Registro de Entregas</h2>
        </div>

        <div class="form-body">
            <table class="entregas-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ãštil Escolar</th>
                        <th style="text-align: center;">Pedido</th>
                        <th style="text-align: center;">Entregado</th>
                        <th style="text-align: center;">Estado</th>
                        <th>Observaciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entrega in entregas %}
                    <tr>
                        <!-- # -->
                        <td class="row-number">{{ forloop.counter }}</td>

                        <!-- Ãštil -->
                        <td>
                            <div class="util-info">
                                <h3>{{ entrega.util.nombre }}</h3>
                                {% if entrega.util.descripcion %}
                                <p>{{ entrega.util.descripcion }}</p>
                                {% endif %}
                                {% if entrega.fecha_entrega %}
                                <div class="fecha-entrega">
                                    <i class="fa-solid fa-clock"></i>
                                    {{ entrega.fecha_entrega|date:"d/m/Y H:i" }}
                                </div>
                                {% endif %}
                            </div>
                        </td>

                        <!-- Pedido -->
                        <td class="cantidad-pedida">
                            {{ entrega.util.cantidad }}
                        </td>

                        <!-- ğŸ”§ NUEVO: Control de Entregado -->
                        <td>
                            <div class="cantidad-control">
                                <button type="button" 
                                        class="cantidad-btn btn-decrease" 
                                        data-entrega-id="{{ entrega.pk }}"
                                        data-max="{{ entrega.util.cantidad }}">
                                    <i class="fa-solid fa-minus"></i>
                                </button>

                                <input type="number" 
                                       name="cantidad_{{ entrega.pk }}" 
                                       id="input_{{ entrega.pk }}"
                                       class="cantidad-input"
                                       value="{{ entrega.cantidad_entregada }}"
                                       min="0"
                                       max="{{ entrega.util.cantidad }}"
                                       data-max="{{ entrega.util.cantidad }}">

                                <button type="button" 
                                        class="cantidad-btn btn-increase" 
                                        data-entrega-id="{{ entrega.pk }}"
                                        data-max="{{ entrega.util.cantidad }}">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </td>

                        <!-- Estado Visual -->
                        <td class="estado-visual">
                            <span class="badge-estado-container" id="badge_{{ entrega.pk }}">
                                {% if entrega.cantidad_entregada >= entrega.util.cantidad %}
                                    <span class="badge-estado completo">
                                        <i class="fa-solid fa-check-circle"></i> Completo
                                    </span>
                                {% elif entrega.cantidad_entregada > 0 %}
                                    <span class="badge-estado parcial">
                                        <i class="fa-solid fa-hourglass-half"></i> Parcial
                                    </span>
                                {% else %}
                                    <span class="badge-estado pendiente">
                                        <i class="fa-solid fa-clock"></i> Pendiente
                                    </span>
                                {% endif %}
                            </span>
                        </td>

                        <!-- Observaciones -->
                        <td>
                            <textarea name="obs_{{ entrega.pk }}" 
                                      class="obs-textarea"
                                      placeholder="Notas u observaciones...">{% if entrega.observaciones %}{{ entrega.observaciones }}{% endif %}</textarea>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="form-footer">
            <a href="{% url 'detalle_alumno' alumno.pk %}" class="btn btn-cancel">
                <i class="fa-solid fa-times"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-submit">
                <i class="fa-solid fa-save"></i> Guardar Cambios
            </button>
        </div>
    </form>
    {% else %}
    <div class="form-card">
        <div class="empty-state">
            <i class="fa-solid fa-inbox"></i>
            <h3>No hay Ãºtiles asignados</h3>
            <p>Agrega Ãºtiles a la lista del salÃ³n primero</p>
            <a href="{% url 'lista_utiles' salon.pk %}" class="btn btn-submit" style="margin-top: 16px;">
                <i class="fa-solid fa-plus"></i> Ir a Lista de Ãštiles
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ”§ NUEVO: Control de cantidades con botones +/-
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    document.addEventListener('DOMContentLoaded', function() {
        // Botones de incrementar
        document.querySelectorAll('.btn-increase').forEach(btn => {
            btn.addEventListener('click', function() {
                const entregaId = this.dataset.entregaId;
                const max = parseInt(this.dataset.max);
                const input = document.getElementById(`input_${entregaId}`);
                
                let valor = parseInt(input.value) || 0;
                if (valor < max) {
                    valor++;
                    input.value = valor;
                    actualizarEstadoVisual(entregaId, valor, max);
                }
            });
        });

        // Botones de decrementar
        document.querySelectorAll('.btn-decrease').forEach(btn => {
            btn.addEventListener('click', function() {
                const entregaId = this.dataset.entregaId;
                const max = parseInt(this.dataset.max);
                const input = document.getElementById(`input_${entregaId}`);
                
                let valor = parseInt(input.value) || 0;
                if (valor > 0) {
                    valor--;
                    input.value = valor;
                    actualizarEstadoVisual(entregaId, valor, max);
                }
            });
        });

        // Cambios manuales en los inputs
        document.querySelectorAll('.cantidad-input').forEach(input => {
            input.addEventListener('input', function() {
                const entregaId = this.id.replace('input_', '');
                const max = parseInt(this.dataset.max);
                let valor = parseInt(this.value) || 0;
                
                // Validar rango
                if (valor < 0) valor = 0;
                if (valor > max) valor = max;
                
                this.value = valor;
                actualizarEstadoVisual(entregaId, valor, max);
            });
        });

        // Actualizar estado visual al cargar
        document.querySelectorAll('.cantidad-input').forEach(input => {
            const entregaId = input.id.replace('input_', '');
            const max = parseInt(input.dataset.max);
            const valor = parseInt(input.value) || 0;
            actualizarEstadoVisual(entregaId, valor, max);
        });
    });

    function actualizarEstadoVisual(entregaId, cantidad, max) {
        const input = document.getElementById(`input_${entregaId}`);
        const badgeContainer = document.getElementById(`badge_${entregaId}`);
        
        // Actualizar clase del input
        input.classList.remove('completo', 'parcial', 'vacio');
        if (cantidad >= max) {
            input.classList.add('completo');
        } else if (cantidad > 0) {
            input.classList.add('parcial');
        } else {
            input.classList.add('vacio');
        }

        // Actualizar badge de estado
        let badgeHTML = '';
        if (cantidad >= max) {
            badgeHTML = '<span class="badge-estado completo"><i class="fa-solid fa-check-circle"></i> Completo</span>';
        } else if (cantidad > 0) {
            badgeHTML = '<span class="badge-estado parcial"><i class="fa-solid fa-hourglass-half"></i> Parcial</span>';
        } else {
            badgeHTML = '<span class="badge-estado pendiente"><i class="fa-solid fa-clock"></i> Pendiente</span>';
        }
        
        badgeContainer.innerHTML = badgeHTML;
    }
</script>

{% endblock %}