{% extends 'layout.html' %}
{% load static %}

{% block title %}Inventario de Útiles Escolares - Sistema{% endblock %}

{% block content %}
<style>
/* ══════════════════════════════════════════════════════════════════
   ESTILOS INVENTARIO DE ÚTILES (EXACTAMENTE igual que Inventario AG)
   ══════════════════════════════════════════════════════════════════ */

* { margin: 0; padding: 0; box-sizing: border-box; }

.inventario-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 30px;
  background-color: transparent;
}

/* ==================== HEADER CON BOTÓN REGRESAR ==================== */
.page-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 30px;
}

.btn-back {
    width: 44px;
    height: 44px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    color: #666;
    text-decoration: none;
    font-size: 18px;
}

.btn-back:hover {
    background: #f1f8f4;
    border-color: #148129;
    color: #148129;
    transform: translateX(-3px);
}

/* ==================== HEADER ==================== */
.inventario-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  background: white;
  padding: 24px 28px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.inventario-header h1 {
  font-size: 26px;
  color: #333;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 12px;
}

.inventario-header h1 i {
  color: #148129;
  font-size: 28px;
}

.header-buttons {
  display: flex;
  gap: 12px;
}

.btn-primary, .btn-secondary {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  text-decoration: none;
}

.btn-primary {
  background: #148129;
  color: white;
  box-shadow: 0 2px 6px rgba(20, 129, 41, 0.3);
}

.btn-primary:hover {
  background: #106020;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(20, 129, 41, 0.4);
}

.btn-secondary {
  background: white;
  color: #148129;
  border: 2px solid #148129;
}

.btn-secondary:hover {
  background: #f1f8f4;
  transform: translateY(-2px);
}

/* ==================== FILTROS ==================== */
.filtros-container {
  background: white;
  padding: 20px 24px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-end;
}

.filtro-grupo {
  flex: 1;
  min-width: 200px;
}

.filtro-grupo label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 600;
  color: #666;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.3px;
}

.filtro-grupo label i {
  color: #148129;
}

.filtro-input {
  width: 100%;
  padding: 11px 14px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  color: #333;
  transition: all 0.3s;
}

.filtro-input:focus {
  outline: none;
  border-color: #148129;
  box-shadow: 0 0 0 3px rgba(20, 129, 41, 0.1);
}

.btn-limpiar {
  padding: 11px 20px;
  background: #f0f0f0;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  white-space: nowrap;
}

.btn-limpiar:hover {
  background: #e0e0e0;
  color: #333;
}

/* ==================== CONTADOR ==================== */
.resultados-info {
  padding: 12px 0;
  font-size: 14px;
  color: #666;
  margin-bottom: 16px;
}

.resultados-info strong {
  color: #148129;
  font-weight: 700;
}

/* ==================== TABLA ==================== */
.tabla-wrapper {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  overflow: hidden;
}

.tabla-container {
  overflow-x: auto;
}

.tabla-inventario {
  width: 100%;
  border-collapse: collapse;
}

.tabla-inventario thead {
  background: #f9f9f9;
  border-bottom: 2px solid #e0e0e0;
}

.tabla-inventario th {
  padding: 14px 16px;
  text-align: left;
  font-size: 12px;
  font-weight: 600;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.tabla-inventario tbody tr {
  border-bottom: 1px solid #eee;
  transition: all 0.2s;
}

.tabla-inventario tbody tr:hover {
  background: #f1f8f4;
}

.tabla-inventario td {
  padding: 14px 16px;
  font-size: 14px;
  color: #333;
}

/* Columnas específicas */
.codigo {
  font-weight: 700;
  color: #148129;
  font-family: 'Courier New', monospace;
}

.nombre {
  font-weight: 600;
  color: #333;
}

.cantidad {
  font-weight: 700;
  color: #333;
  text-align: center;
}

/* ==================== BADGES DE ESTADO ==================== */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}

.estado-disponible {
  background: #d1fae5;
  color: #065f46;
}

.estado-bajo {
  background: #fef3c7;
  color: #92400e;
}

.estado-agotado {
  background: #fee2e2;
  color: #991b1b;
}

/* ==================== ACCIONES ==================== */
.acciones {
  display: flex;
  gap: 8px;
}

.btn-icon {
  width: 34px;
  height: 34px;
  border: none;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  background: #f9f9f9;
  color: #666;
}

.btn-icon:hover {
  transform: scale(1.1);
}

.btn-danger {
  background: #fee2e2;
  color: #991b1b;
}

.btn-danger:hover {
  background: #991b1b;
  color: white;
}

/* ==================== SIN RESULTADOS ==================== */
.sin-resultados {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 60px 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.sin-resultados i {
  font-size: 64px;
  color: #ddd;
  margin-bottom: 16px;
}

.sin-resultados p {
  font-size: 16px;
  color: #666;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
  .inventario-container {
    padding: 15px;
  }

  .page-header {
    flex-wrap: wrap;
  }

  .inventario-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }

  .header-buttons {
    width: 100%;
    flex-direction: column;
  }

  .btn-primary, .btn-secondary {
    width: 100%;
    justify-content: center;
  }

  .filtros-container {
    flex-direction: column;
  }

  .filtro-grupo {
    min-width: 100%;
  }

  .tabla-inventario {
    font-size: 12px;
  }

  .tabla-inventario th,
  .tabla-inventario td {
    padding: 10px 12px;
  }
}
</style>

<div class="inventario-container">
  
  <!-- Header con botón regresar -->
  <header class="page-header">
    <a href="{% url 'almacenes' %}" class="btn-back" title="Regresar">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <div style="flex: 1;">
      <div class="inventario-header" style="margin-bottom: 0;">
        <h1>
          <i class="fa-solid fa-clipboard-list"></i>
          Inventario - Almacén de Útiles
        </h1>

        <div class="header-buttons">
          <a href="{% url 'agregar_producto_utiles' %}">
            <button class="btn-primary">
              <i class="fa-solid fa-plus"></i>
              Agregar Producto
            </button>
          </a>
          <a href="{% url 'importar_excel_utiles' %}">
            <button class="btn-secondary" style="background: white !important; color: #148129 !important; border: 2px solid #148129 !important;">
              <i class="fa-solid fa-file-excel"></i>
              Importar Excel
            </button>
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Filtros -->
  <div class="filtros-container">
    
    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-search"></i>
        Nombre del Producto
      </label>
      <input 
        type="text" 
        id="filtroNombre" 
        class="filtro-input" 
        placeholder="Escribe para buscar..."
      >
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-layer-group"></i>
        Estado
      </label>
      <select id="filtroEstado" class="filtro-input">
        <option value="">Todos los estados</option>
        <option value="DISP">Disponible</option>
        <option value="BAJO">Stock Bajo</option>
        <option value="AGOT">Agotado</option>
      </select>
    </div>

    <div class="filtro-grupo">
      <label>
        <i class="fa-solid fa-location-dot"></i>
        Estante
      </label>
      <input 
        type="text" 
        id="filtroEstante" 
        class="filtro-input" 
        placeholder="Ej: A1, B2..."
      >
    </div>

    <button class="btn-limpiar" onclick="limpiarFiltros()">
      <i class="fa-solid fa-eraser"></i>
      Limpiar Filtros
    </button>

  </div>

  <!-- Contador de resultados -->
  <div class="resultados-info">
    Mostrando <strong id="contadorResultados">{{ total_productos }}</strong> de <strong id="totalProductos">{{ total_productos }}</strong> productos
  </div>

  <!-- Tabla de inventario -->
  <div class="tabla-wrapper">
    <div class="tabla-container">
      <table class="tabla-inventario">
        <thead>
          <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Descripción</th>
            <th>Cantidad</th>
            <th>Unidad</th>
            <th>Ubicación</th>
            <th>Estado</th>
            <th>Fecha Ingreso</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaBody">
          
          {% for producto in productos %}
          <tr data-nombre="{{ producto.nombre|lower }}" 
              data-estado="{{ producto.estado }}" 
              data-estante="{{ producto.estante|lower }}">
            
            <td data-label="Código" class="codigo">{{ producto.codigo_producto }}</td>
            <td data-label="Nombre" class="nombre">{{ producto.nombre }}</td>
            <td data-label="Descripción">{{ producto.descripcion }}</td>
            <td data-label="Cantidad" class="cantidad">{{ producto.cantidad }}</td>
            <td data-label="Unidad">{{ producto.unidad }}</td>
            <td data-label="Ubicación">{{ producto.estante }}</td>
            <td data-label="Estado">
              {% if producto.estado == 'DISP' %}
                <span class="badge estado-disponible">Disponible</span>
              {% elif producto.estado == 'BAJO' %}
                <span class="badge estado-bajo">Stock Bajo</span>
              {% elif producto.estado == 'AGOT' %}
                <span class="badge estado-agotado">Agotado</span>
              {% endif %}
            </td>
            <td data-label="Fecha Ingreso">{{ producto.fecha_ingreso|date:"d/m/Y" }}</td>
            <td data-label="Acciones" class="acciones">
              <button class="btn-icon btn-danger btn-eliminar" 
                      title="Eliminar" 
                      type="button"
                      data-id="{{ producto.id_producto }}" 
                      data-nombre="{{ producto.nombre }}">
                <i class="fa-solid fa-trash"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem;">
              No hay productos registrados en el Almacén de Útiles
            </td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <!-- Mensaje si no hay resultados -->
  <div id="sinResultados" class="sin-resultados" style="display: none;">
    <i class="fa-solid fa-box-open"></i>
    <p>No se encontraron productos con los filtros seleccionados</p>
  </div>

</div>

<script>
// ══════════════════════════════════════════════════════════════════
// FILTRADO EN TIEMPO REAL (EXACTAMENTE igual que Inventario AG)
// ══════════════════════════════════════════════════════════════════

const filtroNombre = document.getElementById('filtroNombre');
const filtroEstado = document.getElementById('filtroEstado');
const filtroEstante = document.getElementById('filtroEstante');
const tablaBody = document.getElementById('tablaBody');
const contadorResultados = document.getElementById('contadorResultados');
const totalProductos = document.getElementById('totalProductos');
const sinResultados = document.getElementById('sinResultados');

// Total de productos
const totalFilas = tablaBody.querySelectorAll('tr[data-nombre]').length;
totalProductos.textContent = totalFilas;

function filtrarTabla() {
  const nombre = filtroNombre.value.toLowerCase();
  const estado = filtroEstado.value;
  const estante = filtroEstante.value.toLowerCase();
  
  const filas = tablaBody.querySelectorAll('tr[data-nombre]');
  let contador = 0;
  
  filas.forEach(fila => {
    const dataNombre = fila.getAttribute('data-nombre');
    const dataEstado = fila.getAttribute('data-estado');
    const dataEstante = fila.getAttribute('data-estante');
    
    const cumpleNombre = nombre === '' || dataNombre.includes(nombre);
    const cumpleEstado = estado === '' || dataEstado === estado;
    const cumpleEstante = estante === '' || dataEstante.includes(estante);
    
    if (cumpleNombre && cumpleEstado && cumpleEstante) {
      fila.style.display = '';
      contador++;
    } else {
      fila.style.display = 'none';
    }
  });
  
  contadorResultados.textContent = contador;
  
  // Mostrar mensaje si no hay resultados
  if (contador === 0 && totalFilas > 0) {
    sinResultados.style.display = 'flex';
    document.querySelector('.tabla-wrapper').style.display = 'none';
  } else {
    sinResultados.style.display = 'none';
    document.querySelector('.tabla-wrapper').style.display = 'block';
  }
}

// Eventos de filtrado en tiempo real
filtroNombre.addEventListener('input', filtrarTabla);
filtroEstado.addEventListener('change', filtrarTabla);
filtroEstante.addEventListener('input', filtrarTabla);

function limpiarFiltros() {
  filtroNombre.value = '';
  filtroEstado.value = '';
  filtroEstante.value = '';
  filtrarTabla();
}

// Manejo de eliminación con event delegation
document.addEventListener('click', function(e) {
  if (e.target.closest('.btn-eliminar')) {
    const btn = e.target.closest('.btn-eliminar');
    const id = btn.getAttribute('data-id');
    const nombre = btn.getAttribute('data-nombre');
    
    if (confirm('¿Estás seguro de eliminar el producto "' + nombre + '"?')) {
      window.location.href = '/eliminar-producto-utiles/' + id + '/';
    }
  }
});
</script>

{% endblock %}